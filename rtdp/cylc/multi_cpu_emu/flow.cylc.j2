{# Multi-CPU Emulator Cylc Workflow Template #}
[scheduler]
    allow implicit tasks = True
    UTC mode = True

[scheduling]
    cycling mode = integer
    initial cycle point = 1
    final cycle point = 1

    [[graph]]
        R1 = """
            # Start chain
            receiver:ready {% for emu in cpu_emulators %}=> emulator_{{ loop.index0 }}:ready {% endfor %}=> sender
            # Completion chain
            sender:succeeded => !receiver
            receiver:completed
        """

[runtime]
    [[root]]
        platform = {{ platform.name | default('jlab_slurm') }}
        [[[job]]]
            execution time limit = PT2H
        [[[directives]]]
            --ntasks = 1
            --partition = {{ partition | default('ifarm') }}
            --output = slurm_%j.log
            --error = slurm_%j.log
        [[[environment]]]
            SIF_FILE = "$CYLC_WORKFLOW_RUN_DIR/sifs/{{ containers.image_path | default('cpu-emu.sif') }}"
            # TODO: Add more global environment variables as needed

    [[receiver]]
        # TODO: Adapt receiver logic for multi-emulator setup if needed
        script = """
        # ... receiver script ...
        """
        [[[directives]]]
            --job-name = receiver
            --cpus-per-task = 4
            --mem = 8G
        [[[outputs]]]
            ready = "ready"
            completed = "Transfer completed successfully"

    {% for emu in cpu_emulators %}
    [[emulator_{{ loop.index0 }}]]
        # Each emulator gets its own config
        script = """
        # ... emulator script for CPU {{ emu.id }} ...
        # TODO: Use emulator-specific variables (e.g., emu.threads, emu.latency, etc.)
        """
        [[[directives]]]
            --job-name = emulator_{{ loop.index0 }}
            --cpus-per-task = {{ emu.cpus | default('8') }}
            --mem = {{ emu.mem | default('16G') }}
        [[[outputs]]]
            ready = "ready"
    {% endfor %}

    [[sender]]
        # TODO: Adapt sender logic for multi-emulator setup if needed
        script = """
        # ... sender script ...
        """
        [[[directives]]]
            --job-name = sender
            --cpus-per-task = 4
            --mem = 8G 