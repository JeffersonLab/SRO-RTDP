<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cylc Workflow Generator</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Bootstrap CSS -->
    {{ bootstrap.load_css() }}

    <!-- Vis Network CSS -->
    <link href="https://unpkg.com/vis-network/dist/dist/vis-network.min.css" rel="stylesheet" type="text/css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/workflow.css') }}">

    <!-- Load dependencies in correct order -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vis-data/standalone/umd/vis-data.min.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/workflow.js') }}"></script>

    <style>
        .form-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: white;
            position: relative;
        }

        .form-section h3 {
            margin-bottom: 1rem;
        }

        .workflow-graph {
            min-height: 600px;
            border: 2px solid #dee2e6;
            border-radius: 0.25rem;
            background-color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: all !important;
            z-index: 1;
        }

        .workflow-graph.drop-target {
            border-color: #2196F3;
            background-color: #E3F2FD;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
            opacity: 1 !important;
        }

        .component-palette {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 2;
            position: relative;
            pointer-events: all !important;
        }

        .palette {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 5px;
            pointer-events: all !important;
        }

        .palette-item-wrapper {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .palette-item {
            cursor: grab !important;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: white;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            margin: 0;
            -webkit-user-drag: element;
            transition: all 0.2s ease;
            position: relative;
            z-index: 100;
            pointer-events: all !important;
            touch-action: none;
            will-change: transform;
            min-width: 100px;
            display: block;
            width: 100%;
        }

        .palette-item:hover {
            border-color: #adb5bd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .palette-item:active {
            cursor: grabbing !important;
            opacity: 0.8;
            transform: scale(0.98);
        }

        .palette-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            cursor: grabbing !important;
        }

        .node {
            padding: 8px;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            pointer-events: none !important;
            transition: all 0.2s ease;
            width: 100%;
            display: block;
            margin: 0;
            border: 2px solid transparent;
        }

        .node.sender {
            background-color: #90EE90;
            border: 2px solid #60c060;
        }

        .node.emulator {
            background-color: #ADD8E6;
            border: 2px solid #7ab5cc;
        }

        .node.receiver {
            background-color: #F08080;
            border: 2px solid #d05050;
        }

        /* Prevent text selection during drag */
        .vis-network,
        .vis-network * {
            user-select: none !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
        }

        /* Ensure the drag ghost image is visible */
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            background: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            opacity: 0.8;
            display: none;
            cursor: grabbing !important;
            will-change: transform;
            touch-action: none;
            min-width: 100px;
        }

        .error-message {
            color: #dc3545;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: #f8d7da;
        }

        .success-message {
            color: #198754;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.25rem;
            background-color: #d1e7dd;
        }

        .modal-dialog {
            max-width: 600px;
        }

        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        #workflow-graph {
            width: 100%;
            height: 600px;
            border: 2px solid #dee2e6;
            background-color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            pointer-events: all !important;
            z-index: 1;
        }

        .vis-network {
            width: 100% !important;
            height: 100% !important;
            position: absolute !important;
            top: 0;
            left: 0;
            background-color: white;
            outline: none;
            pointer-events: all !important;
            z-index: 1;
        }

        /* Drop zone highlight */
        #workflow-graph.drop-target {
            border-color: #2196F3;
            background-color: #E3F2FD;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.3);
            opacity: 1 !important;
        }

        /* Drag visual */
        .dragging {
            position: fixed;
            pointer-events: none;
            z-index: 1000;
            opacity: 0.7;
            transform: translate(-50%, -50%);
            transition: transform 0.2s ease;
        }

        /* Container for the workflow graph */
        .card-body {
            position: relative;
            z-index: 1;
            pointer-events: all !important;
        }

        /* Ensure all parent containers allow pointer events */
        .card,
        .card-body,
        .palette,
        .palette-item {
            pointer-events: all !important;
        }

        /* Disable pointer events only on the node content */
        .node,
        .node * {
            pointer-events: none !important;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Cylc Workflow Generator</a>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- Bootstrap JS -->
    {{ bootstrap.load_js() }}

    {% block scripts %}{% endblock %}
</body>

</html>