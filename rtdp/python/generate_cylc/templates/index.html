{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>CPU Emulator Workflow Configuration</h2>

        <div class="row">
            <!-- Component Palette -->
            <div class="col-md-2">
                <div class="form-section">
                    <h3>Components</h3>
                    <div class="component-palette">
                        <div class="palette-item" draggable="true" data-type="sender">
                            <div class="node sender">Sender</div>
                        </div>
                        <div class="palette-item" draggable="true" data-type="emulator">
                            <div class="node emulator">CPU Emulator</div>
                        </div>
                        <div class="palette-item" draggable="true" data-type="receiver">
                            <div class="node receiver">Receiver</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Graph -->
            <div class="col-md-10">
                <div class="form-section">
                    <h3>Workflow Graph</h3>
                    <div id="workflowGraph" class="workflow-graph"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Platform Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Platform Name</label>
                    <input type="text" id="platformName" class="form-control" value="jlab_slurm">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cylc Path</label>
                    <input type="text" id="cylcPath" class="form-control" value="/path/to/cylc-env/bin/">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">Hosts</label>
                    <input type="text" id="hosts" class="form-control" value="tsai@ifarm2402">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Job Runner</label>
                    <input type="text" id="jobRunner" class="form-control" value="slurm">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Container Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Container Image</label>
                    <input type="text" id="containerImage" class="form-control" value="cpu-emu.sif">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Docker Source</label>
                    <input type="text" id="dockerSource" class="form-control" value="jlabtsai/rtdp-cpu_emu:latest">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Test Data Settings</h3>
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Test Data Size</label>
                    <input type="text" id="testDataSize" class="form-control" value="100M">
                </div>
            </div>
        </div>

        <div class="form-section">
            <button class="btn btn-primary" onclick="generateConfig()">Generate Configuration</button>
            <div id="messages"></div>
        </div>
    </div>
</div>

<!-- Component Configuration Modal -->
<div class="modal fade" id="componentModal" tabindex="-1" aria-labelledby="componentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="componentModalLabel">Component Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="componentForm" class="needs-validation" novalidate>
                    <input type="hidden" id="componentId" name="componentId">
                    <div id="componentFields" class="container-fluid">
                        <!-- Form fields will be dynamically added here -->
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveConfigBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Debug Modal -->
<div class="modal fade" id="debugModal" tabindex="-1" aria-labelledby="debugModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="debugModalLabel">Debug Info</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <pre id="debugInfo"></pre>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize workflow graph when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        try {
            // Initialize workflow graph
            window.workflowGraph = new WorkflowGraph();

            // Set up save button handler
            const saveBtn = document.getElementById('saveConfigBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    if (window.workflowGraph) {
                        window.workflowGraph.saveComponentConfig();
                    }
                });
            }

            // Set up modal events for debugging
            const componentModal = document.getElementById('componentModal');
            if (componentModal) {
                componentModal.addEventListener('show.bs.modal', function (event) {
                    console.log('Modal is about to show');
                    console.log('Modal content:', document.getElementById('componentFields').innerHTML);
                });

                componentModal.addEventListener('shown.bs.modal', function (event) {
                    console.log('Modal is now visible');
                    const firstInput = componentModal.querySelector('input[type="text"], input[type="number"]');
                    if (firstInput) {
                        firstInput.focus();
                    }
                });
            }

            console.log('Initialization complete');
        } catch (error) {
            console.error('Error during initialization:', error);
        }
    });
</script>

<!-- Load our application code -->
<script src="{{ url_for('static', filename='js/workflow.js') }}"></script>
{% endblock %}