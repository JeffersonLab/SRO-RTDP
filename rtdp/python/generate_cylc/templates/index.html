{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2>CPU Emulator Workflow Configuration</h2>

        <div class="row">
            <!-- Component Palette -->
            <div class="col-md-2">
                <div class="form-section">
                    <h3>Components</h3>
                    <div class="component-palette">
                        <div class="palette-item" draggable="true" data-type="sender">
                            <div class="node sender">Sender</div>
                        </div>
                        <div class="palette-item" draggable="true" data-type="emulator">
                            <div class="node emulator">CPU Emulator</div>
                        </div>
                        <div class="palette-item" draggable="true" data-type="receiver">
                            <div class="node receiver">Receiver</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workflow Graph -->
            <div class="col-md-10">
                <div class="form-section">
                    <h3>Workflow Graph</h3>
                    <div id="workflowGraph" class="workflow-graph"></div>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Platform Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Platform Name</label>
                    <input type="text" id="platformName" class="form-control" value="jlab_slurm">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Cylc Path</label>
                    <input type="text" id="cylcPath" class="form-control" value="/path/to/cylc-env/bin/">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-6">
                    <label class="form-label">Hosts</label>
                    <input type="text" id="hosts" class="form-control" value="tsai@ifarm2402">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Job Runner</label>
                    <input type="text" id="jobRunner" class="form-control" value="slurm">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Container Settings</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">Container Image</label>
                    <input type="text" id="containerImage" class="form-control" value="cpu-emu.sif">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Docker Source</label>
                    <input type="text" id="dockerSource" class="form-control" value="jlabtsai/rtdp-cpu_emu:latest">
                </div>
            </div>
        </div>

        <div class="form-section">
            <h3>Test Data Settings</h3>
            <div class="row">
                <div class="col-md-12">
                    <label class="form-label">Test Data Size</label>
                    <input type="text" id="testDataSize" class="form-control" value="100M">
                </div>
            </div>
        </div>

        <div class="form-section">
            <button class="btn btn-primary" onclick="generateConfig()">Generate Configuration</button>
            <div id="messages"></div>
        </div>
    </div>
</div>

<!-- Component Configuration Modal -->
<div class="modal fade" id="componentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Component Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="componentForm">
                    <input type="hidden" id="componentId">
                    <div id="componentFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveComponentConfig()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load dependencies first -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Load vis-network from multiple CDN sources for redundancy -->
<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
    // If the first CDN fails, try loading from another source
    if (typeof vis === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.6/standalone/umd/vis-network.min.js';
        script.onload = function () {
            initWorkflowGraph();
        };
        script.onerror = function () {
            console.error('Failed to load vis-network from both CDN sources');
            alert('Failed to load required libraries. Please check your internet connection and refresh the page.');
        };
        document.head.appendChild(script);
    } else {
        initWorkflowGraph();
    }

    function initWorkflowGraph() {
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGraph);
        } else {
            initGraph();
        }
    }

    function initGraph() {
        try {
            if (typeof vis === 'undefined') {
                throw new Error('vis-network library not loaded');
            }
            console.log('Initializing workflow graph...');
            window.workflowGraph = new WorkflowGraph();
            console.log('Workflow graph initialized successfully');
        } catch (error) {
            console.error('Error initializing workflow graph:', error);
            alert('Error initializing the workflow editor. Please refresh the page and try again.');
        }
    }
</script>

<!-- Load our application code -->
<script src="{{ url_for('static', filename='js/workflow.js') }}"></script>
{% endblock %}