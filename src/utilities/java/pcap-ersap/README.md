# ERSAP Orchestrator for PCAP Processing

This project provides an ERSAP-based orchestration system for processing PCAP files.

## Overview

The system consists of two main components:
1. **pcap2streams**: A Java application that analyzes PCAP files and creates TCP servers for each unique IP address found.
2. **ERSAP Orchestrator**: A service orchestration framework that processes the data from the TCP servers.

## Configuration

The system uses a configuration file generated by `pcap2streams` at:
```
/workspace/src/utilities/java/pcap2streams/custom-config/ip-based-config.json
```

This file contains information about the TCP servers created for each unique IP address, including:
- Port numbers
- IP addresses
- Packet counts
- Buffer sizes
- Connection timeouts

## Running the System

Two scripts are provided to run the system:

### 1. run_ersap_orchestrator.sh

This script:
- Rebuilds the ERSAP environment
- Fixes package structure and imports
- Runs `pcap2streams` to generate the configuration file
- Compiles the application
- Starts the ERSAP orchestrator
- Processes the data
- Checks output files

```bash
cd /workspace/src/utilities/java/pcap-ersap
./scripts/run_ersap_orchestrator.sh
```

### 2. run_ersap_orchestrator_new.sh

This is an alternative script with the same functionality.

```bash
cd /workspace/src/utilities/java/pcap-ersap
./scripts/run_ersap_orchestrator_new.sh
```

## Troubleshooting

If you encounter issues with the configuration file not being created:

1. Make sure `pcap2streams` is not already running:
   ```bash
   ps aux | grep -v grep | grep "java.*Pcap2Streams"
   ```

2. If it is running, stop it:
   ```bash
   pkill -f "java.*Pcap2Streams"
   ```

3. Run the debug script to test `pcap2streams`:
   ```bash
   cd /workspace/src/utilities/java/pcap-ersap
   ./scripts/debug_pcap2streams.sh
   ```

## Output

The system generates output files in the `/workspace/src/utilities/java/pcap-ersap/output/` directory. Each file contains information about a processed packet.

## Important Notes

- The `pcap2streams` application must be run in the foreground to ensure it completes and generates the configuration file before the ERSAP orchestrator starts.
- The PCAP file is expected to be located at `/scratch/jeng-yuantsai/CLAS12_ECAL_PCAL_DC_2024-05-15_17-12-30.pcap`.
- The system will create a custom-config directory if it doesn't exist.

## Components

1. **pcap2streams**: A tool that reads a PCAP file and creates socket servers for each unique IP address.
2. **ERSAP Services**:
   - `PcapSourceService`: Connects to the socket servers and reads packets.
   - `PcapProcessorService`: Processes and filters packets based on protocol and IP address.
   - `PcapSinkService`: Writes processed packets to output files.
3. **ERSAP Orchestrator**: Manages the execution of ERSAP services and coordinates the data flow between them.

## How It Works

1. The `pcap2streams` tool reads a PCAP file and creates socket servers for each unique IP address.
2. The ERSAP Orchestrator starts and manages the services defined in the configuration file.
3. The `PcapSourceService` connects to the socket servers and reads packets.
4. The packets are processed by the `PcapProcessorService` and filtered based on protocol and IP address.
5. The processed packets are written to output files by the `PcapSinkService`.

## Configuration

The workflow is configured using the following files:

- `/workspace/src/utilities/java/pcap2streams/custom-config/ip-based-config.json`: Configures the `pcap2streams` tool.
- `/workspace/src/utilities/java/pcap-ersap/config/pcap-services.yaml`: Configures the ERSAP services.

### ERSAP Orchestrator Configuration

The ERSAP Orchestrator is configured to:

1. Connect to `pcap2streams` socket servers for each IP address (default ports 9000, 9001, 9002)
2. Process packets from these connections
3. Write packet data to output files in the `/workspace/src/utilities/java/pcap-ersap/output` directory

## Output

The workflow generates output files in the `/workspace/src/utilities/java/pcap-ersap/output` directory. Each file contains information about the packets processed, including:

- Packet ID
- Source IP
- Destination IP
- Protocol
- EtherType
- Data length
- Timestamp

Example output:
```
PacketEvent{packetId=0, sourceIp='192.168.10.1', destinationIp='unknown', protocol='unknown', etherType=0x0, dataLength=16384, timestamp=1741548286471}
```

## Troubleshooting

- **"Invalid packet length" warnings**: This is normal. The `pcap2streams` tool may send data that doesn't match the expected packet format. These packets are skipped by the workflow.
- **No output files**: Check that the `pcap2streams` tool is running and that the configuration files are correct.
- **ERSAP orchestrator fails to start**: Check that all the necessary JAR files are present in the correct locations.
- **Compilation errors**: Run the `fix_package_structure.sh` and `fix_imports.sh` scripts to ensure the code is structured correctly.
- **Socket connection errors**: Ensure that `pcap2streams` is running and listening on the expected ports.

## Monitoring

You can monitor the ERSAP orchestrator by:

1. Checking the log output for messages from the Orchestrator
2. Examining the output directory for new files
3. Using system tools to monitor network connections (e.g., `netstat -an | grep 900`)

## Documentation

For more detailed information about the ERSAP orchestration architecture and scripts, please refer to the following documentation:

- [ERSAP Orchestration Architecture](docs/ERSAP_ORCHESTRATION.md): Detailed explanation of the ERSAP orchestration architecture.
- [Script Reference](docs/SCRIPT_REFERENCE.md): Quick reference guide for the scripts used in the ERSAP orchestration workflow.

## Future Work

- Improve packet parsing to handle different packet formats
- Implement a full service chain where packets flow through multiple services
- Add more configuration options to the orchestrator
- Improve error handling and recovery mechanisms
- Add monitoring and metrics collection
- Support for real-time packet processing 